# Apache Security Headers Configuration

## Complete Configuration

```apache
<IfModule mod_headers.c>
    # ====================
    # SECURITY HEADERS
    # ====================
    
    # Content Security Policy (CSP)
    # Prevents XSS and data injection attacks
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://ajax.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
    
    # X-Content-Type-Options
    # Prevents MIME-sniffing attacks
    Header always set X-Content-Type-Options "nosniff"
    
    # X-Frame-Options
    # Prevents clickjacking attacks
    Header always set X-Frame-Options "DENY"
    
    # Strict-Transport-Security (HSTS)
    # Forces HTTPS connections
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # X-XSS-Protection
    # Disable legacy XSS filter (can introduce vulnerabilities)
    Header always set X-XSS-Protection "0"
    
    # Referrer-Policy
    # Controls referrer information sent
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions-Policy (Feature-Policy)
    # Controls browser features and APIs
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
    
    # Cross-Origin-Resource-Policy
    # Prevents other origins from loading resources
    Header always set Cross-Origin-Resource-Policy "same-origin"
    
    # Cross-Origin-Opener-Policy
    # Isolates browsing context
    Header always set Cross-Origin-Opener-Policy "same-origin"
    
    # Cross-Origin-Embedder-Policy
    # Controls loading of cross-origin resources  
    Header always set Cross-Origin-Embedder-Policy "require-corp"
    
    # ====================
    # INFORMATION HIDING
    # ====================
    
    # Remove server version information
    Header always unset X-Powered-By
    Header always unset Server
    Header always set Server "WebServer"
    
    # Remove PHP version
    <FilesMatch "\.php$">
        Header always unset X-Powered-By
    </FilesMatch>
    
</IfModule>

# ====================
# SERVER INFORMATION
# ====================

# Hide Apache version
ServerTokens Prod
ServerSignature Off

# ====================
# SSL/TLS CONFIGURATION
# ====================

<IfModule mod_ssl.c>
    # Enable HTTPS
    SSLEngine on
    
    # Modern SSL configuration
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    
    # Strong cipher suites
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
</IfModule>

# ====================
# COOKIE SECURITY
# ====================

# Set secure cookie flags (PHP)
<IfModule mod_php7.c>
    php_flag session.cookie_httponly on
    php_flag session.cookie_secure on
    php_value session.cookie_samesite Strict
</IfModule>

# ====================
# DIRECTORY PROTECTION
# ====================

# Disable directory listing
<Directory "/var/www/html">
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# Protect sensitive files
<FilesMatch "\.(env|git|htaccess|htpasswd|ini|log|sh|sql|bak|backup)$">
    Require all denied
</FilesMatch>

# Protect .git directory
<DirectoryMatch "^/.*/\.git/">
    Require all denied
</DirectoryMatch>

# ====================
# CONTENT TYPE HEADERS
# ====================

<IfModule mod_mime.c>
    # Set correct MIME types
    AddType application/javascript js
    AddType application/json json
    AddType text/css css
    AddType text/html html htm
    AddType image/svg+xml svg svgz
    AddType application/font-woff woff
    AddType application/font-woff2 woff2
</IfModule>

# ====================
# COMPRESSION
# ====================

<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# ====================
# CACHING HEADERS
# ====================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# ====================
# REQUEST LIMITS
# ====================

# Limit request body size (prevent DoS)
LimitRequestBody 10485760  # 10MB

# Connection timeout
Timeout 60

# ====================
# MOD_SECURITY (if available)
# ====================

<IfModule security2_module>
    # Enable ModSecurity WAF
    SecRuleEngine On
    
    # Use OWASP CRS
    Include /etc/modsecurity/modsecurity.conf
    Include /etc/modsecurity/crs/crs-setup.conf
    Include /etc/modsecurity/crs/rules/*.conf
</IfModule>

# ====================
# ADDITIONAL PROTECTION
# ====================

# Prevent HTTP TRACE method
TraceEnable Off

# Disable ETags
FileETag None

# ====================
# FORCE HTTPS REDIRECT
# ====================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Redirect HTTP to HTTPS
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Remove www
    RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
    RewriteRule ^(.*)$ https://%1/$1 [R=301,L]
</IfModule>
```

## Installation Instructions

### 1. Enable Required Apache Modules

```bash
sudo a2enmod headers
sudo a2enmod ssl
sudo a2enmod rewrite
sudo a2enmod expires
sudo a2enmod deflate
```

### 2. Apply Configuration

**Option A: In Virtual Host**

Edit your virtual host config:
```bash
sudo nano /etc/apache2/sites-available/000-default-le-ssl.conf
```

Add the security headers inside the `<VirtualHost>` block.

**Option B: In .htaccess**

Create/edit `.htaccess` in your web root:
```bash
sudo nano /var/www/html/.htaccess
```

Paste the configuration (excluding VirtualHost directives).

**Option C: In httpd.conf**

Edit main Apache config:
```bash
sudo nano /etc/apache2/apache2.conf
```

### 3. Test Configuration

```bash
# Test for syntax errors
sudo apachectl configtest

# If OK, restart Apache
sudo systemctl restart apache2
```

### 4. Verify Headers

```bash
# Using curl
curl -I https://yourdomain.com

# Check specific header
curl -I https://yourdomain.com | grep "Content-Security-Policy"
```

## Testing

### Online Tools

1. **SecurityHeaders.com**
   ```
   https://securityheaders.com/?q=https://yourdomain.com
   ```

2. **Mozilla Observatory**
   ```
   https://observatory.mozilla.org/
   ```

3. **SSL Labs**
   ```
   https://www.ssllabs.com/ssltest/
   ```

### Expected Grade

After implementing these headers:
- **SecurityHeaders.com**: A or A+
- **Mozilla Observatory**: A or A+

## Customization

### CSP for Specific Needs

**If you need inline scripts** (not recommended):
```apache
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline';"
```

**With nonce for inline scripts** (better):
```apache
# Generate nonce in your application
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'nonce-RANDOM_VALUE';"
```

**For development** (very permissive):
```apache
Header always set Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval';"
```

### HSTS for Subdomains

```apache
# Include all subdomains
Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

# Only main domain
Header always set Strict-Transport-Security "max-age=31536000"
```

## Troubleshooting

### Images Not Loading

**Issue**: CSP blocking images from CDN

**Fix**:
```apache
Header always set Content-Security-Policy "... img-src 'self' https://cdn.example.com ..."
```

### Fonts Not Loading

**Issue**: CSP blocking Google Fonts

**Fix**:
```apache
Header always set Content-Security-Policy "... font-src 'self' https://fonts.gstatic.com; style-src 'self' https://fonts.googleapis.com ..."
```

### Scripts Not Working

**Issue**: CSP blocking inline scripts

**Fix**: Use nonces or move scripts to external files

## Monitoring

### CSP Violation Reports

Add reporting to CSP:
```apache
Header always set Content-Security-Policy "... report-uri /csp-violation-report; report-to csp-endpoint"
Header always set Report-To '{"group":"csp-endpoint","max_age":10886400,"endpoints":[{"url":"/csp-violation-report"}]}'
```

Create endpoint to receive reports (`/csp-violation-report`).

## Resources

- Apache mod_headers Documentation
- OWASP Secure Headers Project
- Mozilla Web Security Guidelines
- SecurityHeaders.com
